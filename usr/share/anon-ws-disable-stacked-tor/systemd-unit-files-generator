## Copyright (C) 2012 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd "$MYDIR"
cd ..
cd ..
cd ..

mkdir -p usr/share/lintian/overrides

echo "\
## Copyright (C) 2017 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

## Dummy script does not need a man page. Original man page still available.
anon-ws-disable-stacked-tor: binary-without-manpage usr/sbin/tor.anondist
" > usr/share/lintian/overrides/anon-ws-disable-stacked-tor

rm -f lib/systemd/system/anon-ws-disable-stacked-tor_autogen_*

exit

port_list+=" 9050 " ## system Tor default SocksPort
port_list+=" 9150 " ## Tor Browser Bundle default SocksPort
port_list+=" 9152 " ## Tor Messenger default SocksPort
port_list+=" 9051 " ## Tor default ControlPort
port_list+=" 9151 " ## Tor Browser Bundle default ControlPort
port_list+=" 9153 " ## Tor Messenger default ControlPort

for single_port in $port_list ; do
   echo "\
## Copyright (C) 2017 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

[Unit]
Description=redirect 127.0.0.1:$single_port to Whonix-Gateway
Documentation=https://www.whonix.org/wiki/Dev/anon-ws-disable-stacked-tor
ConditionPathExists=/var/run/qubes/this-is-templatevm

[Socket]
ListenStream=127.0.0.1:$single_port

[Install]
WantedBy=sockets.target" > "./lib/systemd/system/anon-ws-disable-stacked-tor_autogen_${single_port}.socket"

echo "\
## Copyright (C) 2017 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

[Unit]
Description=redirect 127.0.0.1:9050 to Whonix-Gateway in Qubes TemplateVM service
Documentation=https://github.com/Whonix/qubes-whonix
ConditionPathExists=/var/run/qubes/this-is-templatevm
After=qubes-whonix-redirect-9050.socket
Requires=qubes-whonix-redirect-9050.socket

[Service]
ExecStart=/lib/systemd/systemd-socket-proxyd 10.152.152.10:9050
PrivateTmp=yes" > "./lib/systemd/system/anon-ws-disable-stacked-tor_autogen_${single_port}.service"

echo "\
## Copyright (C) 2017 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

## false positive lintian warning for static systemd unit file
## http://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2017-March/014380.html
## https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=832771#32
qubes-whonix: systemd-service-file-missing-install-key lib/systemd/system/anon-ws-disable-stacked-tor-_autogen_${single_port}.service
" > ./usr/share/lintian/overrides/anon-ws-disable-stacked-tor


done

## Create a unix domain socket files such as
## /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9050.sock and forward those
## to $GATEWAY_IP:9150 etc. See also:
## https://phabricator.whonix.org/T192
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9050.sock#9050 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock#9150 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9152.sock#9152 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9051.sock#9051 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9151.sock#9151 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9153.sock#9153 "

## system Tor default SocksSocket
file_port_tuples+=" /var/run/tor/socks#9050 "

## Debian /usr/share/tor/tor-service-defaults-torrc uses '/var/run/tor/control' Tor ControlSocket
file_port_tuples+=" /var/run/tor/control#9051 "

for item in $file_port_tuples ; do
   file_item="${item%#*}"
   port="${item##*#}"

   echo socat -t100 UNIX-LISTEN:"$file_item",mode=777,reuseaddr,fork TCP:$GATEWAY_IP:"$port" &
done

## To test this, you could use:
## sudo --non-interactive -u debian-tor socat - UNIX-CONNECT:/var/run/tor/socks
## Then type:
## GET
## <enter>
## The expected reply includes 'Tor is not an HTTP Proxy'.
