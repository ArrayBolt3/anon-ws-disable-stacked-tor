#!/bin/bash

## Copyright (C) 2012 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

MYDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

## Change to either system or package source code root folder.
cd "$MYDIR"
cd ..
cd ..
cd ..

mkdir -p usr/share/lintian/overrides

echo "\
## Copyright (C) 2017 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

## This file get auto generated by $BASH_SOURCE.

## Dummy script does not need a man page. Original man page still available.
anon-ws-disable-stacked-tor: binary-without-manpage usr/sbin/tor.anondist

## false positive lintian warning for static systemd unit file
## http://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2017-March/014380.html
## https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=832771#32" > usr/share/lintian/overrides/anon-ws-disable-stacked-tor

rm -f lib/systemd/system/anon-ws-disable-stacked-tor_autogen_*

file_port_tuples+=" port#9050 " ## system Tor default SocksPort
file_port_tuples+=" port#9150 " ## Tor Browser Bundle default SocksPort
file_port_tuples+=" port#9152 " ## Tor Messenger default SocksPort
file_port_tuples+=" port#9051 " ## Tor default ControlPort
file_port_tuples+=" port#9151 " ## Tor Browser Bundle default ControlPort
file_port_tuples+=" port#9153 " ## Tor Messenger default ControlPort

## Create a unix domain socket files such as
## /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9050.sock and forward those
## to $GATEWAY_IP:9150 etc. See also:
## https://phabricator.whonix.org/T192
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9050.sock#9050 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock#9150 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9152.sock#9152 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9051.sock#9051 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9151.sock#9151 "
file_port_tuples+=" /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9153.sock#9153 "

## system Tor default SocksSocket
file_port_tuples+=" /var/run/tor/socks#9050 "

## Debian /usr/share/tor/tor-service-defaults-torrc uses '/var/run/tor/control' Tor ControlSocket
file_port_tuples+=" /var/run/tor/control#9051 "

for item in $file_port_tuples ; do
   file_item="${item%#*}"
   single_port="${item##*#}"

   if [ "$file_item" = "port" ]; then
      listen_where="127.0.0.1:$single_port"
      file_name="port_${single_port}"
   else
      listen_where="$file_item"
      file_basename="${file_item##*/}"
      file_name=${file_item//\//\_}
   fi

   echo "\
## Copyright (C) 2018 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

## This file get auto generated by $BASH_SOURCE.

[Unit]
Description=redirect $listen_where to Whonix-Gateway port ${single_port}
Documentation=https://www.whonix.org/wiki/Dev/anon-ws-disable-stacked-tor
ConditionPathExists=!/var/run/qubes/this-is-templatevm

[Socket]
ListenStream=$listen_where

[Install]
WantedBy=sockets.target" > "./lib/systemd/system/anon-ws-disable-stacked-tor_autogen_${file_name}.socket"

   echo "\
## Copyright (C) 2018 - 2018 ENCRYPTED SUPPORT LP <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

## This file get auto generated by $BASH_SOURCE.

[Unit]
Description=redirect $listen_where to Whonix-Gateway port ${single_port}
Documentation=https://www.whonix.org/wiki/Dev/anon-ws-disable-stacked-tor
ConditionPathExists=!/var/run/qubes/this-is-templatevm
After=anon-ws-disable-stacked-tor_autogen_${file_name}.socket
Requires=anon-ws-disable-stacked-tor_autogen_${file_name}.socket

[Service]
ExecStart=/lib/systemd/systemd-socket-proxyd 10.152.152.10:${single_port}
PrivateTmp=yes" > "./lib/systemd/system/anon-ws-disable-stacked-tor_autogen_${file_name}.service"

   echo "\
anon-ws-disable-stacked-tor: systemd-service-file-missing-install-key lib/systemd/system/anon-ws-disable-stacked-tor_autogen_${file_name}.service" >> ./usr/share/lintian/overrides/anon-ws-disable-stacked-tor

done

## To test this, you could use:
## sudo --non-interactive -u debian-tor socat - UNIX-CONNECT:/var/run/tor/socks
## Then type:
## GET
## <enter>
## The expected reply includes 'Tor is not an HTTP Proxy'.
