## This file is part of Whonix.
## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

## Please use "/etc/anon-ws-disable-stacked-tor.d/50_user.conf" for your custom
## configuration, which will override the defaults found here.
## When anon-ws-disable-stacked-tor is updated, this file may be overwritten

## Do not try to execute this file. Files in folder /etc/anon-ws-disable-stacked-tor.d
## are `source`d in lexical order by the anon-ws-disable-stacked-tor package by script:
## /usr/lib/anon-ws-disable-stacked-tor/socat-unix-sockets
## Start and stop is up to the anon-ws-disable-stacked-tor systemd service.

## Usage:
## sudo service anon-ws-disable-stacked-tor stop
## sudo service anon-ws-disable-stacked-tor start
## sudo service anon-ws-disable-stacked-tor restart
## sudo service anon-ws-disable-stacked-tor status

## bash fragment

[ -n "$pre_command" ] || pre_command="sudo --non-interactive -u debian-tor"

## Cleanup eventual stale files.
rm --force --verbose /var/run/anon-ws-disable-stacked-tor/*.sock 2>/dev/null || true
rm --force --verbose /var/run/tor/control 2>/dev/null || true
rm --force --verbose /var/run/tor/socks 2>/dev/null || true

############
## Tor SocksPorts #
############

## system Tor default SocksPort
$pre_command socat TCP-LISTEN:9050,fork,bind=127.0.0.1 TCP:$GATEWAY_IP:9050 &

## Tor Browser Bundle default SocksPort
$pre_command socat TCP-LISTEN:9150,fork,bind=127.0.0.1 TCP:$GATEWAY_IP:9150 &

## TorChat default SocksPort
$pre_command socat TCP-LISTEN:11109,fork,bind=127.0.0.1 TCP:$GATEWAY_IP:9119 &

## Tor Messenger default SocksPort
$pre_command socat TCP-LISTEN:9152,fork,bind=127.0.0.1 TCP:$GATEWAY_IP:9152 &

## Tor default ControlPort
$pre_command socat TCP-LISTEN:9051,fork,bind=127.0.0.1 TCP:$GATEWAY_IP:9051 &

## Tor Browser Bundle default ControlPort
$pre_command socat TCP-LISTEN:9151,fork,bind=127.0.0.1 TCP:$GATEWAY_IP:9051 &

## Tor Messenger default ControlPort
$pre_command socat TCP-LISTEN:9153,fork,bind=127.0.0.1 TCP:$GATEWAY_IP:9051 &

#####################
## Tor Control Auth Cookie Files #
#####################

mkdir --parents /var/run/tor
mkdir --parents /var/lib/tor
mkdir --parents /var/run/anon-ws-disable-stacked-tor

## system Tor default '/var/run/tor/control.authcookie' auth cookie file
cp /usr/share/anon-ws-disable-stacked-tor/control.authcookie /var/run/tor/control.authcookie

## tor-firejail uses '/var/run/tor/control_auth_cookie' auth cookie file
## https://git.schwanenlied.me/yawning/tor-firejail/src/master/start-tor-browser
## https://lists.torproject.org/pipermail/tor-dev/2016-July/011226.html
## https://lists.torproject.org/pipermail/tor-dev/2016-July/011227.html
cp /usr/share/anon-ws-disable-stacked-tor/control.authcookie /var/run/tor/control_auth_cookie

## Tor by default uses '/var/lib/tor/control_auth_cookie' auth cookie file
## https://trac.torproject.org/projects/tor/ticket/19572
cp /usr/share/anon-ws-disable-stacked-tor/control.authcookie /var/lib/tor/control_auth_cookie

chown --recursive debian-tor:debian-tor /var/lib/tor
chmod --recursive 777 /var/lib/tor

chown --recursive debian-tor:debian-tor /var/run/tor
chmod --recursive 777 /var/run/tor

chown --recursive debian-tor:debian-tor /var/run/anon-ws-disable-stacked-tor
chmod --recursive 777 /var/run/anon-ws-disable-stacked-tor

########################
## ControlPorts unix domain sockets #
########################

## Debian /usr/share/tor/tor-service-defaults-torrc uses '/var/run/tor/control'.
$pre_command socat -t100 UNIX-LISTEN:/var/run/tor/control,mode=777,reuseaddr,fork TCP:$GATEWAY_IP:9051 &

## Create a unix domain socket files such as
## /var/run/anon-ws-disable-stacked-tor/127.0.0.1_9050.sock and forward those
## to 127.0.0.1:9150 etc. from where socat accepts it and forwards it to the
## gateway. See also:
## https://phabricator.whonix.org/T192
$pre_command socat -t100 UNIX-LISTEN:/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9050.sock,mode=777,reuseaddr,fork TCP:127.0.0.1:9050 &
$pre_command socat -t100 UNIX-LISTEN:/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock,mode=777,reuseaddr,fork TCP:127.0.0.1:9150 &
$pre_command socat -t100 UNIX-LISTEN:/var/run/anon-ws-disable-stacked-tor/127.0.0.1_11109.sock,mode=777,reuseaddr,fork TCP:127.0.0.1:11109 &
$pre_command socat -t100 UNIX-LISTEN:/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9152.sock,mode=777,reuseaddr,fork TCP:127.0.0.1:9152 &
$pre_command socat -t100 UNIX-LISTEN:/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9051.sock,mode=777,reuseaddr,fork TCP:127.0.0.1:9051 &
$pre_command socat -t100 UNIX-LISTEN:/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9151.sock,mode=777,reuseaddr,fork TCP:127.0.0.1:9151 &
$pre_command socat -t100 UNIX-LISTEN:/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9153.sock,mode=777,reuseaddr,fork TCP:127.0.0.1:9153 &

$pre_command socat -t100 UNIX-LISTEN:/var/run/tor/socks,mode=777,reuseaddr,fork TCP:127.0.0.1:9050 &

## To test this, you could use:
## sudo --non-interactive -u debian-tor socat - UNIX-CONNECT:/var/run/tor/socks
## Then type:
## GET
## <enter>
## The expected reply includes 'Tor is not an HTTP Proxy'.
